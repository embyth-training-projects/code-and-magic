"use strict";window.GameConstants={Fireball:{size:window.fireballSize||24,speed:window.getFireballSpeed||function(e){return e?2:5}},Wizard:{speed:window.wizardSpeed||2,width:window.wizardWidth||61,getHeight:window.getWizardHeight||function(e){return 1.377*e},getX:window.getWizardX||function(e){return e/3},getY:window.getWizardY||function(e){return e-100}}},window.Game=function(){var s=300,n=700,e=0,a=["Кекс","Катя","Игорь"],t=[e][0],r=0,o=1,i=0,d=1,h=1,c=2,u=4,l=8,w={},f="-reversed";w[r]={width:61,height:84,url:"img/wizard.gif"},w[r+f]={width:61,height:84,url:"img/wizard-reversed.gif"},w[o]={width:24,height:24,url:"img/fireball.gif"};var g={};g[r]=function(e,t,i){t.keysPressed.UP&&0<e.y&&(e.direction=e.direction&~l,e.direction=e.direction|u,e.y-=e.speed*i*2),t.keysPressed.UP||e.y<s-e.height&&(e.direction=e.direction&~u,e.direction=e.direction|l,e.y+=e.speed*i/3),t.keysPressed.LEFT&&(e.direction=e.direction&~c,e.direction=e.direction|h,e.x-=e.speed*i),t.keysPressed.RIGHT&&(e.direction=e.direction&~h,e.direction=e.direction|c,e.x+=e.speed*i),e.y<0&&(e.y=0),e.y>s-e.height&&(e.y=s-e.height),e.x<0&&(e.x=0),e.x>n-e.width&&(e.x=n-e.width)},g[o]=function(e,t,i){e.direction&h&&(e.x-=e.speed*i),e.direction&c&&(e.x+=e.speed*i),(e.x<0||e.x>n)&&(e.state=d)};var y={CONTINUE:0,WIN:1,FAIL:2,PAUSE:3,INTRO:4},m={};m[e]=function(e){return e.garbage.filter(function(e){return e.type===o}).filter(function(e){return e.x<10&&240<e.y})[0]?y.WIN:y.CONTINUE};var v={};v[e]=function(e){return e.objects.push({direction:c,height:window.GameConstants.Wizard.getHeight(window.GameConstants.Wizard.width),speed:window.GameConstants.Wizard.speed,sprite:w[r],state:i,type:r,width:window.GameConstants.Wizard.width,x:window.GameConstants.Wizard.getX(n),y:window.GameConstants.Wizard.getY(s)}),e};function p(e){this.container=e,this.canvas=document.createElement("canvas"),this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._pauseListener=this._pauseListener.bind(this),this.setDeactivated(!1)}p.prototype={level:t,setDeactivated:function(e){this._deactivated!==e&&((this._deactivated=e)?this._removeGameListeners():this._initializeGameListeners())},getInitialState:function(){return{currentStatus:y.CONTINUE,garbage:[],lastUpdated:null,keysPressed:{ESC:!1,LEFT:!1,RIGHT:!1,SPACE:!1,UP:!1},levelStartTime:null,objects:[],startTime:null}},initializeLevelAndStart:function(e){(e=void 0===e||e)||!this.state?(this._imagesArePreloaded=void 0,this.state=this.getInitialState(),this.state=v[this.level](this.state)):this.state.currentStatus=y.CONTINUE,this.state.levelStartTime=Date.now(),this.state.startTime||(this.state.startTime=this.state.levelStartTime),this._preloadImagesForLevel(function(){this.render(),this._initializeGameListeners(),this.update()}.bind(this))},pauseLevel:function(e){e&&(this.state.currentStatus=e),this.state.keysPressed.ESC=!1,this.state.lastUpdated=null,this._removeGameListeners(),window.addEventListener("keydown",this._pauseListener),this._drawPauseScreen()},_pauseListener:function(e){if(32===e.keyCode&&!this._deactivated){e.preventDefault();var t=this.state.currentStatus===y.WIN||this.state.currentStatus===y.FAIL;this.initializeLevelAndStart(t),window.removeEventListener("keydown",this._pauseListener)}},_drawPauseScreen:function(){var e;switch(this.state.currentStatus){case y.WIN:if(window.renderStatistics){var t=this._generateStatistics(new Date-this.state.startTime),i=this._shuffleArray(Object.keys(t));return void window.renderStatistics(this.ctx,i,i.map(function(e){return t[e]}))}e="Вы победили Газебо!\nУра!";break;case y.FAIL:e="Вы проиграли!";break;case y.PAUSE:e="Игра на паузе!\nНажмите Пробел, чтобы продолжить";break;case y.INTRO:e="Добро пожаловать!\nНажмите Пробел для начала игры"}this._drawMessage(e)},_generateStatistics:function(e){for(var t={"Вы":e},i=0;i<a.length;i++){var s=e+(3e3*Math.random()-1500);s<1e3&&(s=1e3),t[a[i]]=s}return t},_shuffleArray:function(e){for(var t=e.length-1;0<t;t--){var i=Math.floor(Math.random()*(t+1)),s=e[t];e[t]=e[i],e[i]=s}return e},_drawMessage:function(e){function t(e,t,i,s){n.beginPath(),n.moveTo(e,t),n.lineTo(e+10,t+s/2),n.lineTo(e,t+s),n.lineTo(e+i/2,t+s-10),n.lineTo(e+i,t+s),n.lineTo(e+i-10,t+s/2),n.lineTo(e+i,t),n.lineTo(e+i/2,t+10),n.lineTo(e,t),n.stroke(),n.closePath(),n.fill()}var n=this.ctx;n.fillStyle="rgba(0, 0, 0, 0.7)",t(190,40,320,100),n.fillStyle="rgba(256, 256, 256, 1.0)",t(180,30,320,100),n.fillStyle="#000",n.font="16px PT Mono",e.split("\n").forEach(function(e,t){n.fillText(e,200,80+20*t)})},_preloadImagesForLevel:function(i){if(void 0===this._imagesArePreloaded&&(this._imagesArePreloaded=[]),this._imagesArePreloaded[this.level])i();else for(var e=Object.keys(w),s=e.length,n=this,t=function(e){var t=new Image(e.width,e.height);t.onload=function(){e.image=t,0==--s&&(n._imagesArePreloaded[n.level]=!0,i())},t.src=e.url},a=0;a<e.length;a++)t(w[e[a]])},updateObjects:function(t){var e=this.state.objects.filter(function(e){return e.type===r})[0];this.state.keysPressed.SHIFT&&(this.state.objects.push({direction:e.direction,height:window.GameConstants.Fireball.size,speed:window.GameConstants.Fireball.speed(!!(e.direction&h)),sprite:w[o],type:o,width:window.GameConstants.Fireball.size,x:e.direction&c?e.x+e.width:e.x-window.GameConstants.Fireball.size,y:e.y+e.height/2}),this.state.keysPressed.SHIFT=!1),this.state.garbage=[];var i=this.state.objects.filter(function(e){return g[e.type](e,this.state,t),e.state!==d||(this.state.garbage.push(e),!1)},this);this.state.objects=i},checkStatus:function(){if(this.state.currentStatus===y.CONTINUE){this.commonRules||(this.commonRules=[function(e){return e.objects.filter(function(e){return e.type===r})[0].state===d?y.FAIL:y.CONTINUE},function(e){return e.keysPressed.ESC?y.PAUSE:y.CONTINUE},function(e){return 18e4<Date.now()-e.startTime?y.FAIL:y.CONTINUE}]);for(var e=this.commonRules.concat(m[this.level]),t=y.CONTINUE;t===y.CONTINUE&&e.length;)t=e.shift()(this.state);this.state.currentStatus=t}},setGameStatus:function(e){this.state.currentStatus!==e&&(this.state.currentStatus=e)},render:function(){this.ctx.clearRect(0,0,n,s),this.state.objects.forEach(function(e){if(e.sprite){var t=e.direction&h,i=w[e.type+(t?f:"")]||w[e.type];this.ctx.drawImage(i.image,e.x,e.y,e.width,e.height)}},this)},update:function(){this.state.lastUpdated||(this.state.lastUpdated=Date.now());var e=(Date.now()-this.state.lastUpdated)/10;switch(this.updateObjects(e),this.checkStatus(),this.state.currentStatus){case y.CONTINUE:this.state.lastUpdated=Date.now(),this.render(),requestAnimationFrame(function(){this.update()}.bind(this));break;case y.WIN:case y.FAIL:case y.PAUSE:case y.INTRO:this.pauseLevel()}},_onKeyDown:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!0;break;case 39:this.state.keysPressed.RIGHT=!0;break;case 38:this.state.keysPressed.UP=!0;break;case 27:this.state.keysPressed.ESC=!0}e.shiftKey&&(this.state.keysPressed.SHIFT=!0)},_onKeyUp:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!1;break;case 39:this.state.keysPressed.RIGHT=!1;break;case 38:this.state.keysPressed.UP=!1;break;case 27:this.state.keysPressed.ESC=!1}e.shiftKey&&(this.state.keysPressed.SHIFT=!1)},_initializeGameListeners:function(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)},_removeGameListeners:function(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}},p.Verdict=y;var S=new p(document.querySelector(".demo"));return window.restartGame=function(e,t){w[r].url=e,w[r+f].url=t,S.initializeLevelAndStart(),S.setGameStatus(y.INTRO)},window.restartGame("img/wizard.gif","img/wizard-reversed.gif"),S}();